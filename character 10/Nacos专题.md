# Nacos专题

## 1、Q&A

> 1、什么是Nacos？

Nacos本质是一个中间件，主要作用于微服务架构和云原生环境中，提供服务注册、配置管理和服务管理能力。

1. **服务注册**<br>
   让服务能够彼此发现对方，不需要关心具体IP和端口的变化。<br><br>
2. **配置管理**<br>
   集中式管理配置、统一推送<br><br>
3. **服务管理**<br>
   服务健康检查，动态路由，版本灰度<br><br>

> 2、Nacos是如何实现服务注册的？

1. 服务实例类型

- 临时实例 (Ephemeral)
    - 客户端会**定时发送心跳** (默认5秒一次)
    - 如果超时 (默认15秒没有收到)，Nacos会**剔除该实例**
    - 适合云原生环境、弹性伸缩场景 (容器随时上下线)
- 持久实例 (Persistent)
    - 不依赖心跳，实例信息持久化到MySQL
    - 适合不希望因短暂网络抖动就被剔除的服务

2. 注册流程

- 临时实例
    - 客户端启动时
        - 调用`POST /nacos/v1/ns/instance`(或gRPC注册接口)，携带服务名、IP、端口、集群名、元数据等信息。
    - 服务端处理注册请求
        - 将实例信息存储到**内存注册表(Service Registry)**中
        - 如果是集群模式，会通过`Raft协议`同步到`Leader`，并由`Leader`复制到`Follower`节点。
    - 心跳维持
        - 客户端定时发送`PUT /nacos/v1/ns/instance/beat`(或gRPC心跳包)。
        - 服务端更新该实例的最后活跃时间。
    - 实例过期剔除
        - 定时任务扫描注册表，超过`timeout`(默认15秒)未更新心跳的实例会被剔除，并出发服务变更通知。
- 持久化实例
    - 客户端启动，通过HTTP API或gRPC调用`POST /nacos/v1/ns/instance`注册
        - 参数中包含：
            - ephemeral=false(非临时实例)
            - 服务名(serviceName)
            - IP、端口
            - 集群名、元数据
    - 服务端处理
        - 写入内存注册表，将实例信息存入内存中的服务注册表(Service Registry)。
        - 持久化实例不会依赖心跳维持状态，而是直接将实例数据写入MySQL的`service_info`表
        - 一旦Nacos服务端重启，也可以从MySQL里恢复数据
        - 如果是集群模式，Leader节点会先写MySQL，在通过`Raft`协议同步给其他`Follower`节点，保证一致性
    - 无需心跳
        - 持久化实例不需要客户端发送心跳包。
        - 实例上下线的状态完全通过显示注册和下限来控制。
        - 优点：
            - 不会因为短暂的网络抖动被剔除。
            - 减少心跳网络开销。
        - 缺点：
            - 如果服务进程异常退出，Nacos不能及时感知，需要人工或者其他监控系统去删除实例。

> 3、Nacos如何感知一个实例宕机？

Nacos感知一个实例宕机，取决于实例类型是临时实例，还是持久化实例。

- 临时实例
    - 客户端心跳
        - 服务注册完成后，客户端会周期性(默认5秒)向Nacos发送心跳包(Http或gRPC)。
    - 服务端维护过期时间
        - 服务端接收到心跳后，会更新该实例的`lastBeat`时间戳。
    - 剔除服务并推送通知
        - 服务端会从注册表中剔除实例，并通过长轮询(Http)或gRPC推送最新实例列表给订阅者
    - 缺点：
        - 如果机器卡死或者服务宕机，可能需要等到超时时间(默认15秒)才能感知到服务不可用或宕机。
- 持久化实例
    - 持久化实例不会自动依赖心跳剔除
    - 服务端只会在显示调用下线接口`DELETE /nacos/v1/ns/instance`时才会移除实例
    - 借助外部的中间件(Prometheus+AlterManager、Kubernetes、KeepAlive)调用API`DELETE /nacos/v1/ns/instance`下线
-

另外，在实际场景中，Nacos的宕机检测时间窗口可通过以下参数进行调整：https://nacos.io/docs/v2.5/guide/admin/system-configurations/